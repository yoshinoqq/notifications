name: Test Application Logic

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-logic:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build and start application
      run: |
        docker compose build
        docker compose up -d
        
    - name: Wait for application to be ready
      run: |
        echo "Waiting for application to start..."
        # Ждем пока приложение реально запустится
        for i in {1..30}; do
          if docker compose logs | grep -q "started\|ready\|listening\|Running"; then
            echo "✅ Application is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 5
        done
        
    - name: Check service status
      run: |
        echo "=== Service status ==="
        docker compose ps
        echo "=== Recent logs ==="
        docker compose logs --tail=50
        

        
    - name: Test main functionality
      run: |
        echo "Testing API endpoint..."
        # Пробуем с таймаутом и повторными попытками
        for i in {1..5}; do
          if curl -v -X POST http://localhost:8080/notifications \
            -H "Content-Type: application/json; charset=utf-8" \
            -d '{ "message": "Привет, это тест!"}' \
            --max-time 10 --retry 2; then
            echo "✅ API test passed!"
            exit 0
          else
            echo "⚠️ Attempt $i failed, retrying..."
            sleep 5
          fi
        done
        echo "❌ All API attempts failed"
        exit 1
        
    - name: Cleanup
      if: always()
      run: docker compose down